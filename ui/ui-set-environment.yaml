---
- name: Switch Active UI Bot Environment
  hosts: master
  tasks:
    - name: Ensure required environment variables are provided
      ansible.builtin.assert:
        that:
          - lookup('env','ACTIVE_NAMESPACE') | length > 0
          - lookup('env','INACTIVE_NAMESPACE') | length > 0
          - lookup('env','ACTIVE_ENV') | length > 0
        fail_msg: "Missing required environment variables: ACTIVE_NAMESPACE, INACTIVE_NAMESPACE, ACTIVE_ENV"

    - name: Display switch information
      ansible.builtin.debug:
        msg:
          - "Switching UI bot to: {{ lookup('env', 'ACTIVE_ENV') }}"
          - "Active namespace: {{ lookup('env', 'ACTIVE_NAMESPACE') }}"
          - "Inactive namespace: {{ lookup('env', 'INACTIVE_NAMESPACE') }}"

    - name: Scale down inactive environment
      ansible.builtin.shell: |
        kubectl scale deployment/eightbitsaxlounge-ui \
          --replicas=0 \
          --namespace="$INACTIVE_NAMESPACE"
      environment:
        INACTIVE_NAMESPACE: "{{ lookup('env', 'INACTIVE_NAMESPACE') }}"
      register: scale_down_result
      failed_when: false

    - name: Display scale down result
      ansible.builtin.debug:
        msg: "{{ scale_down_result.stdout if scale_down_result.rc == 0 else 'Inactive Environment scaled down.' }}"

    - name: Wait for inactive environment to scale down
      ansible.builtin.shell: |
        kubectl wait --for=delete pod \
          -l app=eightbitsaxlounge,component=ui \
          --namespace="$INACTIVE_NAMESPACE" \
          --timeout=60s || true
      environment:
        INACTIVE_NAMESPACE: "{{ lookup('env', 'INACTIVE_NAMESPACE') }}"
      changed_when: false

    - name: Scale up active environment
      ansible.builtin.shell: |
        kubectl scale deployment/eightbitsaxlounge-ui \
          --replicas=1 \
          --namespace="$ACTIVE_NAMESPACE"
      environment:
        ACTIVE_NAMESPACE: "{{ lookup('env', 'ACTIVE_NAMESPACE') }}"

    - name: Wait for active environment to be ready
      ansible.builtin.shell: |
        kubectl rollout status deployment/eightbitsaxlounge-ui \
          --namespace="$ACTIVE_NAMESPACE" \
          --timeout=120s
      environment:
        ACTIVE_NAMESPACE: "{{ lookup('env', 'ACTIVE_NAMESPACE') }}"

    - name: Get active pod status
      ansible.builtin.shell: |
        kubectl get pods -n "$ACTIVE_NAMESPACE" \
          -l app=eightbitsaxlounge,component=ui \
          -o wide
      register: active_pods
      environment:
        ACTIVE_NAMESPACE: "{{ lookup('env', 'ACTIVE_NAMESPACE') }}"

    - name: Display active pods
      ansible.builtin.debug:
        msg: "{{ active_pods.stdout_lines }}"

    - name: Get recent logs from active environment
      ansible.builtin.shell: |
        kubectl logs -n "$ACTIVE_NAMESPACE" \
          -l app=eightbitsaxlounge,component=ui \
          --tail=20
      register: active_logs
      environment:
        ACTIVE_NAMESPACE: "{{ lookup('env', 'ACTIVE_NAMESPACE') }}"
      ignore_errors: yes

    - name: Display recent logs
      ansible.builtin.debug:
        msg: "{{ active_logs.stdout_lines }}"
      when: active_logs.rc == 0

    - name: Verify bot connection
      ansible.builtin.debug:
        msg:
          - "âœ… Environment switch complete!"
          - "Active: {{ lookup('env', 'ACTIVE_ENV') }} ({{ lookup('env', 'ACTIVE_NAMESPACE') }})"
          - "Check logs above to verify Twitch connection"
