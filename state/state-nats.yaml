---
- name: Deploy NATS JetStream to Kubernetes
  hosts: master
  tasks:
    - name: Ensure required environment variables are provided
      ansible.builtin.assert:
        that:
          - lookup('env','NAMESPACE') | length > 0
        fail_msg: "Missing required env var: NAMESPACE. Ensure the workflow passes it to Ansible."

    - name: Create a temporary directory for manifests
      ansible.builtin.tempfile:
        state: directory
        suffix: nats-k8s
      register: tempdir

    - name: Copy NATS ConfigMap to temp directory
      ansible.builtin.copy:
        src: k8s/configmap.yaml
        dest: "{{ tempdir.path }}/configmap.yaml"

    - name: Copy NATS headless service to temp directory
      ansible.builtin.copy:
        src: k8s/service-headless.yaml
        dest: "{{ tempdir.path }}/service-headless.yaml"

    - name: Copy NATS StatefulSet to temp directory
      ansible.builtin.copy:
        src: k8s/statefulset.yaml
        dest: "{{ tempdir.path }}/statefulset.yaml"

    - name: Copy NATS client service to temp directory
      ansible.builtin.copy:
        src: k8s/service-client.yaml
        dest: "{{ tempdir.path }}/service-client.yaml"

    - name: Deploy NATS manifests (ordered)
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/configmap.yaml
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/service-headless.yaml
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/statefulset.yaml
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/service-client.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Wait for StatefulSet rollout
      ansible.builtin.shell: |
        kubectl -n $NAMESPACE rollout status sts/nats --timeout=180s || true
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Verify PVCs created
      ansible.builtin.shell: |
        kubectl -n $NAMESPACE get pvc -l app=nats -o wide
      register: pvc_list
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"
      changed_when: false

    - name: Print PVCs
      ansible.builtin.debug:
        var: pvc_list.stdout_lines

    - name: Remove temporary directory
      ansible.builtin.file:
        path: "{{ tempdir.path }}"
        state: absent
