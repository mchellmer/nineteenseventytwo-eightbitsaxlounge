name: MIDI Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - midi/*
    paths:
      - 'midi/version.txt'

permissions:
  contents: write
  packages: write

jobs:
  lint:
    name: Lint .NET Code
    runs-on: self-hosted
    if: false # Disabled - too slow on RPi
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run lint
        working-directory: ./midi
        run: make lint

  # Check if we need to build before running expensive tests
  check-artifacts:
    name: Check if Artifacts Exist
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
      namespace: ${{ steps.namespace.outputs.namespace }}
      needs-build-container: ${{ steps.check-container.outputs.needs-build }}
      needs-build-pc: ${{ steps.check-pc.outputs.needs-build }}
      needs-build: ${{ steps.determine.outputs.needs-build }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Read Version
        id: version
        working-directory: ./midi
        run: |
          VERSION=$(cat version.txt)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set Namespace
        id: namespace
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "namespace=eightbitsaxlounge-prod" >> $GITHUB_OUTPUT
          else
            echo "namespace=eightbitsaxlounge-dev" >> $GITHUB_OUTPUT
          fi

      - name: Check if container image exists
        id: check-container
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use GitHub Packages API to check if the version exists
          # This is more reliable than the Docker registry API
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-midi/versions")
          
          echo "API Response Code: $RESPONSE"
          
          if [ "$RESPONSE" = "200" ]; then
            # Get the list of versions and check if our version exists
            VERSION_EXISTS=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-midi/versions" \
              | jq -r '.[] | .metadata.container.tags[] | select(. == "${{ steps.version.outputs.version }}")' | head -n 1)
            
            if [ -n "$VERSION_EXISTS" ]; then
              echo "needs-build=false" >> $GITHUB_OUTPUT
              echo "✓ Container image exists - will skip build and tests"
            else
              echo "needs-build=true" >> $GITHUB_OUTPUT
              echo "✗ Container image not found - will build and test"
            fi
          else
            # If we can't access the API (404, 403, etc.), assume it doesn't exist and build
            echo "needs-build=true" >> $GITHUB_OUTPUT
            echo "✗ Could not check container image (HTTP $RESPONSE) - will build and test"
          fi

      - name: Check if GitHub Release exists
        id: check-pc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="midi-api-v${{ steps.version.outputs.version }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "needs-build=false" >> $GITHUB_OUTPUT
            echo "✓ GitHub Release exists - will skip build"
          else
            echo "needs-build=true" >> $GITHUB_OUTPUT
            echo "✗ GitHub Release not found - will build"
          fi

      - name: Determine if any build needed
        id: determine
        run: |
          if [ "${{ steps.check-container.outputs.needs-build }}" = "true" ] || [ "${{ steps.check-pc.outputs.needs-build }}" = "true" ]; then
            echo "needs-build=true" >> $GITHUB_OUTPUT
            echo "Will run tests and build"
          else
            echo "needs-build=false" >> $GITHUB_OUTPUT
            echo "All artifacts exist - will skip tests and build"
          fi

  test:
    name: Run .NET Tests
    runs-on: self-hosted
    needs: [check-artifacts]
    if: needs.check-artifacts.outputs.needs-build == 'true'
    env:
      # Dummy configuration for tests
      Authentication__SecretKey: "dummySecretKeyForTestingOnly1234567890123456789012"
      Authentication__Issuer: "Test"
      Authentication__Audience: "Test"
      Authentication__TokenExpiryInMinutes: "5"
      ConnectionStrings__EightBitSaxLoungeDataLayer: "http://localhost:5000"
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run tests
        working-directory: ./midi
        run: make test

  # Kubernetes container build
  build-container:
    name: Build MIDI Container
    needs: [check-artifacts, test]
    if: always() && needs.check-artifacts.outputs.needs-build-container == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: self-hosted
    permissions:
      packages: write
      security-events: write
    outputs:
      version: ${{ needs.check-artifacts.outputs.version }}
      namespace: ${{ needs.check-artifacts.outputs.namespace }}
      needs-build: ${{ needs.check-artifacts.outputs.needs-build-container }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Container
        working-directory: ./midi
        env:
          VERSION: ${{ needs.check-artifacts.outputs.version }}
          NAMESPACE: ${{ needs.check-artifacts.outputs.namespace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: make build-container

      - name: Security Scan MIDI Container
        if: false # Disabled - too slow on RPi
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/${{ github.repository_owner }}/eightbitsaxlounge-midi:${{ needs.check-artifacts.outputs.version }}'
          format: 'sarif'
          output: 'midi/trivy-results.sarif'

      - name: Upload Trivy Results to GitHub Security
        if: false # Disabled - too slow on RPi
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'midi/trivy-results.sarif'

  # Windows PC build
  build-pc:
    name: Build Windows PC Package
    needs: [check-artifacts, test]
    if: always() && needs.check-artifacts.outputs.needs-build-pc == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: self-hosted
    outputs:
      version: ${{ needs.check-artifacts.outputs.version }}
      needs-build: ${{ needs.check-artifacts.outputs.needs-build-pc }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup .NET
      run: |
        curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --channel 8.0 --install-dir $HOME/.dotnet
        echo "$HOME/.dotnet" >> $GITHUB_PATH

    - name: Publish Windows application
      working-directory: ./midi/NineteenSeventyTwo.EightBitSaxLounge.Midi
      run: |
        $HOME/.dotnet/dotnet publish NineteenSeventyTwo.EightBitSaxLounge.Midi.MinimalApi/NineteenSeventyTwo.EightBitSaxLounge.Midi.MinimalApi.csproj \
          --configuration Release \
          --runtime win-x64 \
          --self-contained true \
          -p:PublishSingleFile=false \
          -p:Version=${{ needs.check-artifacts.outputs.version }} \
          --output ${{ github.workspace }}/midi/publish/bin

    - name: Create artifact archive
      working-directory: ./midi/publish/bin
      run: tar -czf ../midi-api-${{ needs.check-artifacts.outputs.version }}.tar.gz *

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: midi-api-${{ needs.check-artifacts.outputs.version }}
        path: midi/publish/midi-api-${{ needs.check-artifacts.outputs.version }}.tar.gz
        retention-days: 90
        compression-level: 0

    - name: Create GitHub Release
      if: github.ref_name == 'main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: midi-api-v${{ needs.check-artifacts.outputs.version }}
        name: MIDI API v${{ needs.check-artifacts.outputs.version }}
        files: midi/publish/midi-api-${{ needs.check-artifacts.outputs.version }}.tar.gz
        body: |
          ## MIDI API Release v${{ needs.check-artifacts.outputs.version }}
          
          **Production deployment**
          - Self-contained Windows x64 binary
          - Deployed to: C:\Services\Midi\prod
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Kubernetes deployment (runs in parallel with deploy-pc after both builds complete)
  deploy-k8s:
    name: Deploy MIDI to Kubernetes
    needs: [check-artifacts, build-container, test]
    if: always() && needs.build-container.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to Kubernetes
      working-directory: ./midi
      env:
        VERSION: ${{ needs.check-artifacts.outputs.version }}
        NEEDS_BUILD: ${{ needs.check-artifacts.outputs.needs-build-container }}
        NAMESPACE: ${{ needs.check-artifacts.outputs.namespace }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        AUTH_SECRET_KEY: ${{ secrets.AUTHENTICATION_SECRETKEY }}
        AUTH_ISSUER: ${{ secrets.AUTHENTICATION_ISSUER }}
        AUTH_AUDIENCE: ${{ secrets.AUTHENTICATION_AUDIENCE }}
        AUTH_CLIENT_0_ID: ${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTID }}
        AUTH_CLIENT_0_SECRET: ${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTSECRET }}
        AUTH_CLIENT_1_ID: ${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTID }}
        AUTH_CLIENT_1_SECRET: ${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTSECRET }}
        CONNECTION_STRING_DEV: ${{ secrets.CONNECTIONSTRINGS_EIGHTBITSAXLOUNGEDATALAYER_DEV }}
        CONNECTION_STRING_PROD: ${{ secrets.CONNECTIONSTRINGS_EIGHTBITSAXLOUNGEDATALAYER_PROD }}
        DEVICE_SERVICE_URL_DEV: ${{ secrets.MIDI_DEVICE_URL_DEV }}
        DEVICE_SERVICE_URL_PROD: ${{ secrets.MIDI_DEVICE_URL_PROD }}
        DEVICE_BYPASS_KEY: ${{ secrets.MIDI_DEVICE_BYPASS_KEY }}
        TOKEN_EXPIRY: ${{ secrets.AUTHENTICATION_TOKENEXPIRYINMINUTES }}
      run: make deploy-k8s

  # Windows PC deployment (runs in parallel with deploy-k8s after both builds complete)
  deploy-pc:
    name: Deploy to Windows PC
    needs: [check-artifacts, build-pc, test]
    if: always() && needs.build-pc.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Download artifact from workflow (if just built)
      if: needs.check-artifacts.outputs.needs-build-pc == 'true'
      uses: actions/download-artifact@v4
      with:
        name: midi-api-${{ needs.check-artifacts.outputs.version }}
        path: artifacts

    - name: Download artifact from GitHub Release (if using existing version)
      if: needs.check-artifacts.outputs.needs-build-pc == 'false'
      run: |
        mkdir -p artifacts
        curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/octet-stream" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/midi-api-v${{ needs.check-artifacts.outputs.version }}" \
          | jq -r '.assets[] | select(.name == "midi-api-${{ needs.check-artifacts.outputs.version }}.tar.gz") | .url' \
          | xargs -I {} curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/octet-stream" {} \
          -o artifacts/midi-api-${{ needs.check-artifacts.outputs.version }}.tar.gz

    - name: Deploy MIDI PC
      working-directory: ./midi
      env:
        VERSION: ${{ needs.check-artifacts.outputs.version }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        ARTIFACT_PATH: ${{ github.workspace }}/artifacts/midi-api-${{ needs.check-artifacts.outputs.version }}.tar.gz
        NEEDS_BUILD: ${{ needs.check-artifacts.outputs.needs-build-pc }}
        CONNECTIONSTRINGS__EIGHTBITSAXLOUNGEDATALAYER: ${{ secrets.CONNECTIONSTRINGS_EIGHTBITSAXLOUNGEDATALAYER }}
        AUTHENTICATION__TOKENEXPIRYINMINUTES: ${{ secrets.AUTHENTICATION_TOKENEXPIRYINMINUTES }}
        AUTHENTICATION__SECRETKEY: ${{ secrets.AUTHENTICATION_SECRETKEY }}
        AUTHENTICATION__ISSUER: ${{ secrets.AUTHENTICATION_ISSUER }}
        AUTHENTICATION__AUDIENCE: ${{ secrets.AUTHENTICATION_AUDIENCE }}
        AUTHENTICATION__CLIENTS__0__CLIENTID: ${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTID }}
        AUTHENTICATION__CLIENTS__0__CLIENTSECRET: ${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTSECRET }}
        AUTHENTICATION__CLIENTS__1__CLIENTID: ${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTID }}
        AUTHENTICATION__CLIENTS__1__CLIENTSECRET: ${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTSECRET }}
        MIDIDEVICESERVICE__BYPASSKEY: ${{ secrets.MIDI_DEVICE_BYPASS_KEY }}
      run: make deploy-pc
