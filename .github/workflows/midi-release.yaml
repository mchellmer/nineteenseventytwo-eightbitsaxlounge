name: MIDI API Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - midi/*
    paths:
      - 'midi/version.txt'

permissions:
  contents: write
  packages: write

jobs:
  # Container release for Kubernetes
  release-k8s:
    name: Release MIDI Container (K8s)
    permissions:
      packages: write
    uses: ./.github/workflows/release-template.yaml
    with:
      component: 'midi'
      test-target: 'test'
      build-target: 'build-container'
      deploy-target: 'deploy-k8s'
      requires-docker-login: true
    secrets:
      component-secrets: |
        {
          "AUTH_SECRET_KEY": "${{ secrets.AUTHENTICATION_SECRETKEY }}",
          "AUTH_ISSUER": "${{ secrets.AUTHENTICATION_ISSUER }}",
          "AUTH_AUDIENCE": "${{ secrets.AUTHENTICATION_AUDIENCE }}",
          "AUTH_CLIENT_0_ID": "${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTID }}",
          "AUTH_CLIENT_0_SECRET": "${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTSECRET }}",
          "AUTH_CLIENT_1_ID": "${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTID }}",
          "AUTH_CLIENT_1_SECRET": "${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTSECRET }}",
          "CONNECTION_STRING_DEV": "${{ secrets.CONNECTIONSTRINGS_EIGHTBITSAXLOUNGEDATALAYER_DEV }}",
          "CONNECTION_STRING_PROD": "${{ secrets.CONNECTIONSTRINGS_EIGHTBITSAXLOUNGEDATALAYER_PROD }}",
          "DEVICE_SERVICE_URL_DEV": "${{ secrets.MIDI_DEVICE_URL_DEV }}",
          "DEVICE_SERVICE_URL_PROD": "${{ secrets.MIDI_DEVICE_URL_PROD }}",
          "DEVICE_BYPASS_KEY": "${{ secrets.MIDI_DEVICE_BYPASS_KEY }}",
          "TOKEN_EXPIRY": "${{ secrets.AUTHENTICATION_TOKENEXPIRYINMINUTES }}"
        }

  # Windows PC deployment  
  build-pc:
    name: Build Windows PC Package
    needs: release-k8s
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Read version
      id: version
      working-directory: ./midi
      run: echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT

    - name: Build Windows package
      working-directory: ./midi
      env:
        VERSION: ${{ steps.version.outputs.version }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
      run: make build-pc

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: midi-api-${{ steps.version.outputs.version }}
        path: midi/publish/midi-api-${{ steps.version.outputs.version }}.tar.gz
        retention-days: 90
        compression-level: 0

    - name: Create GitHub Release
      if: github.ref_name == 'main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: midi-api-v${{ steps.version.outputs.version }}
        name: MIDI API v${{ steps.version.outputs.version }}
        files: midi/publish/midi-api-${{ steps.version.outputs.version }}.tar.gz
        body: |
          ## MIDI API Release v${{ steps.version.outputs.version }}
          
          **Production deployment**
          - Self-contained Windows x64 binary
          - Deployed to: C:\Services\Midi\prod
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pc:
    name: Deploy to Windows PC
    needs: build-pc
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Read version
      id: version
      working-directory: ./midi
      run: echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: midi-api-${{ steps.version.outputs.version }}
        path: artifacts

    - name: Deploy MIDI PC
      working-directory: ./midi
      env:
        VERSION: ${{ steps.version.outputs.version }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        ARTIFACT_PATH: ${{ github.workspace }}/artifacts/midi-api-${{ steps.version.outputs.version }}.tar.gz
        CONNECTIONSTRINGS__EIGHTBITSAXLOUNGEDATALAYER: ${{ secrets.CONNECTIONSTRINGS_EIGHTBITSAXLOUNGEDATALAYER }}
        AUTHENTICATION__TOKENEXPIRYINMINUTES: ${{ secrets.AUTHENTICATION_TOKENEXPIRYINMINUTES }}
        AUTHENTICATION__SECRETKEY: ${{ secrets.AUTHENTICATION_SECRETKEY }}
        AUTHENTICATION__ISSUER: ${{ secrets.AUTHENTICATION_ISSUER }}
        AUTHENTICATION__AUDIENCE: ${{ secrets.AUTHENTICATION_AUDIENCE }}
        AUTHENTICATION__CLIENTS__0__CLIENTID: ${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTID }}
        AUTHENTICATION__CLIENTS__0__CLIENTSECRET: ${{ secrets.AUTHENTICATION_CLIENTS_0_CLIENTSECRET }}
        AUTHENTICATION__CLIENTS__1__CLIENTID: ${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTID }}
        AUTHENTICATION__CLIENTS__1__CLIENTSECRET: ${{ secrets.AUTHENTICATION_CLIENTS_1_CLIENTSECRET }}
        MIDIDEVICESERVICE__BYPASSKEY: ${{ secrets.MIDI_DEVICE_BYPASS_KEY }}
      run: make deploy-pc
