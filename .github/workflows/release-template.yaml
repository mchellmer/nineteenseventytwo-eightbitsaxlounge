name: Reusable Release

on:
  workflow_call:
    inputs:
      component:
        description: 'Component name (matches directory: db, data, midi, ui)'
        required: true
        type: string
      version-file:
        description: 'Path to version file relative to component directory'
        required: false
        type: string
        default: 'version.txt'
      build-target:
        description: 'Make target for building (e.g., build, build-image)'
        required: false
        type: string
        default: 'build'
      test-target:
        description: 'Make target for testing (empty to skip)'
        required: false
        type: string
        default: ''
      package-target:
        description: 'Make target for packaging (empty to skip)'
        required: false
        type: string
        default: ''
      deploy-target:
        description: 'Make target for deployment'
        required: true
        type: string
      requires-docker-login:
        description: 'Whether component requires Docker/GHCR authentication'
        required: false
        type: boolean
        default: true
    secrets:
      component-secrets:
        description: 'JSON object of component-specific secrets to pass as environment variables'
        required: false

jobs:
  test:
    name: Test
    runs-on: self-hosted
    if: inputs.test-target != ''
    defaults:
      run:
        working-directory: ./${{ inputs.component }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run Tests
        run: make ${{ inputs.test-target }}

  build:
    name: Build and Package
    runs-on: self-hosted
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      packages: write
    defaults:
      run:
        working-directory: ./${{ inputs.component }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      namespace: ${{ steps.namespace.outputs.namespace }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Read Version
        id: version
        run: |
          VERSION=$(cat ${{ inputs.version-file }})
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set Namespace Based on Branch
        id: namespace
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            NAMESPACE="eightbitsaxlounge-prod"
          else
            NAMESPACE="eightbitsaxlounge-dev"
          fi
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: inputs.requires-docker-login
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        env:
          VERSION: ${{ steps.version.outputs.version }}
          NAMESPACE: ${{ steps.namespace.outputs.namespace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: make ${{ inputs.build-target }}

      - name: Package
        if: inputs.package-target != ''
        env:
          VERSION: ${{ steps.version.outputs.version }}
          NAMESPACE: ${{ steps.namespace.outputs.namespace }}
        run: make ${{ inputs.package-target }}

  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: [build]
    defaults:
      run:
        working-directory: ./${{ inputs.component }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy
        env:
          VERSION: ${{ needs.build.outputs.version }}
          NAMESPACE: ${{ needs.build.outputs.namespace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          # Parse component-specific secrets from JSON and export as env vars
          if [[ -n "$SECRETS_JSON" ]]; then
            while IFS="=" read -r key value; do
              export "$key=$value"
            done < <(echo "$SECRETS_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"')
          fi
          
          make ${{ inputs.deploy-target }}
        shell: bash
        env:
          SECRETS_JSON: ${{ secrets.component-secrets }}
