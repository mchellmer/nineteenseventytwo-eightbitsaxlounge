name: Reusable Release

on:
  workflow_call:
    inputs:
      component:
        description: 'Component name (matches directory: db, data, midi, ui)'
        required: true
        type: string
      version-file:
        description: 'Path to version file relative to component directory'
        required: false
        type: string
        default: 'version.txt'
      build-target:
        description: 'Make target for building (e.g., build, build-image)'
        required: false
        type: string
        default: 'build'
      test-target:
        description: 'Make target for testing (empty to skip)'
        required: false
        type: string
        default: ''
      lint-target:
        description: 'Make target for linting (empty to skip)'
        required: false
        type: string
        default: ''
      package-target:
        description: 'Make target for packaging (empty to skip)'
        required: false
        type: string
        default: ''
      deploy-target:
        description: 'Make target for deployment'
        required: true
        type: string
      requires-docker-login:
        description: 'Whether component requires Docker/GHCR authentication'
        required: false
        type: boolean
        default: true
    secrets:
      component-secrets:
        description: 'JSON object of component-specific secrets to pass as environment variables'
        required: false

jobs:
  publish:
    name: Build, Test & Publish
    runs-on: self-hosted
    permissions:
      packages: write
      security-events: write
    defaults:
      run:
        working-directory: ./${{ inputs.component }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      namespace: ${{ steps.namespace.outputs.namespace }}
      image-exists: ${{ steps.final-check.outputs.image-exists }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Read Version
        id: version
        run: |
          VERSION=$(cat ${{ inputs.version-file }})
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "üì¶ Version: $VERSION"

      - name: Set Namespace Based on Branch
        id: namespace
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            NAMESPACE="eightbitsaxlounge-prod"
          else
            NAMESPACE="eightbitsaxlounge-dev"
          fi
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_ENV
          echo "üéØ Namespace: $NAMESPACE"

      - name: Check if image exists in registry
        id: check-artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE="ghcr.io/${{ github.repository_owner }}/eightbitsaxlounge-${{ inputs.component }}:${VERSION}"
          echo "üîç Checking if image exists: $IMAGE"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-${{ inputs.component }}/versions")
          
          if [ "$RESPONSE" = "200" ]; then
            VERSION_EXISTS=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-${{ inputs.component }}/versions" \
              | jq -r --arg ver "$VERSION" '.[] | .metadata.container.tags[] | select(. == $ver)' | head -n 1)
            
            if [ -n "$VERSION_EXISTS" ]; then
              echo "needs-build=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Image exists - skipping build"
            else
              echo "needs-build=true" >> $GITHUB_OUTPUT
              echo "üî® Image not found - will build"
            fi
          else
            echo "needs-build=true" >> $GITHUB_OUTPUT
            echo "üî® Cannot verify image (HTTP $RESPONSE) - will build"
          fi

      - name: Log in to GitHub Container Registry
        if: inputs.requires-docker-login && steps.check-artifact.outputs.needs-build == 'true'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Image
        if: steps.check-artifact.outputs.needs-build == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          NAMESPACE: ${{ steps.namespace.outputs.namespace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          echo "üî® Building ${{ inputs.component }} version $VERSION"
          make build-image

      - name: Run Unit Tests
        if: inputs.test-target != '' && steps.check-artifact.outputs.needs-build == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "üß™ Testing ${{ inputs.component }} version $VERSION"
          make ${{ inputs.test-target }}

      - name: Test Built Image
        if: steps.check-artifact.outputs.needs-build == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          echo "üîç Verifying built image"
          make test-image

      - name: Push Image to Registry
        if: steps.check-artifact.outputs.needs-build == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          echo "üì¶ Pushing ${{ inputs.component }} version $VERSION to registry"
          make push

      - name: Verify Image Was Published
        if: steps.check-artifact.outputs.needs-build == 'true'
        id: verify-publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE="ghcr.io/${{ github.repository_owner }}/eightbitsaxlounge-${{ inputs.component }}:${VERSION}"
          echo "‚úÖ Verifying image was published: $IMAGE"
          
          # Wait a bit for registry to update
          sleep 5
          
          # Check if the version now exists
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-${{ inputs.component }}/versions")
          
          if [ "$RESPONSE" = "200" ]; then
            VERSION_EXISTS=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-${{ inputs.component }}/versions" \
              | jq -r --arg ver "$VERSION" '.[] | .metadata.container.tags[] | select(. == $ver)' | head -n 1)
            
            if [ -n "$VERSION_EXISTS" ]; then
              echo "‚úÖ Image successfully published to registry"
            else
              echo "‚ùå ERROR: Image was not found in registry after build"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  Cannot verify image publication (HTTP $RESPONSE)"
            echo "Build completed but verification failed - proceeding with caution"
          fi

      - name: Final Image Status
        id: final-check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # One final check to confirm image exists
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-${{ inputs.component }}/versions")
          
          if [ "$RESPONSE" = "200" ]; then
            VERSION_EXISTS=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/eightbitsaxlounge-${{ inputs.component }}/versions" \
              | jq -r --arg ver "$VERSION" '.[] | .metadata.container.tags[] | select(. == $ver)' | head -n 1)
            
            if [ -n "$VERSION_EXISTS" ]; then
              echo "image-exists=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Ready for deployment: Image $VERSION exists in registry"
            else
              echo "image-exists=false" >> $GITHUB_OUTPUT
              echo "‚ùå ERROR: Image $VERSION not found in registry"
              exit 1
            fi
          else
            echo "image-exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå ERROR: Cannot verify image in registry (HTTP $RESPONSE)"
            exit 1
          fi

  deploy:
    name: Deploy Configuration
    runs-on: self-hosted
    needs: [publish]
    if: always() && inputs.deploy-target != '' && needs.publish.result == 'success' && needs.publish.outputs.image-exists == 'true'
    defaults:
      run:
        working-directory: ./${{ inputs.component }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Display Deployment Info
        run: |
          echo "üöÄ Deploying ${{ inputs.component }}"
          echo "   Version: ${{ needs.publish.outputs.version }}"
          echo "   Namespace: ${{ needs.publish.outputs.namespace }}"
          echo "   Image verified in registry: ‚úÖ"

      - name: Deploy
        env:
          VERSION: ${{ needs.publish.outputs.version }}
          NAMESPACE: ${{ needs.publish.outputs.namespace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          SECRETS_JSON: ${{ secrets.component-secrets }}
        run: |
          # Parse component-specific secrets from JSON and export as env vars
          if [[ -n "$SECRETS_JSON" ]]; then
            while IFS="=" read -r key value; do
              export "$key=$value"
            done < <(echo "$SECRETS_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"')
          fi
          
          echo "üì¶ Deploying configuration for version $VERSION"
          make ${{ inputs.deploy-target }}
        shell: bash
