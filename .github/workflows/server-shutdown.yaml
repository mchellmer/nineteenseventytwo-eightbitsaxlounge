name: Server Shutdown

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "SHUTDOWN" to confirm cluster shutdown'
        required: true
        type: string

jobs:
  shutdown:
    name: Shutdown Kubernetes Cluster
    runs-on: self-hosted
    if: github.event.inputs.confirmation == 'SHUTDOWN'
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Display shutdown warning
      run: |
        echo "⚠️  WARNING: Shutting down entire Kubernetes cluster ⚠️"
        echo ""
        echo "This will shutdown:"
        echo "  1. Worker nodes"
        echo "  2. Master node"
        echo "  3. Console/Runner machine"
        echo ""
        echo "The cluster will be completely offline after this operation."
        echo "Physical access will be required to restart the machines."
        echo ""

    - name: Shutdown cluster
      working-directory: ./server
      run: make shutdown-cluster

  cancelled:
    name: Shutdown Cancelled
    runs-on: self-hosted
    if: github.event.inputs.confirmation != 'SHUTDOWN'
    steps:
    - name: Display cancellation message
      run: |
        echo "❌ Shutdown cancelled: confirmation did not match"
        echo "Expected: SHUTDOWN"
        echo "Received: ${{ github.event.inputs.confirmation }}"
        exit 1
