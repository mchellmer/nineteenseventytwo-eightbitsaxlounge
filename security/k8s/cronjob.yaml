apiVersion: batch/v1
kind: CronJob
metadata:
  name: security-scan-daily
  labels:
    app: security-scanner
spec:
  schedule: "0 2 * * *" # daily at 02:00 UTC
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: security-scanner
        spec:
          restartPolicy: OnFailure
          containers:
            - name: scanner
              # Replace with your built/published security-scanner image that includes trivy, gh, git, jq
              image: ghcr.io/YOUR_ORG/security-scanner:latest
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: trivy-cache
                  mountPath: /var/lib/trivy
                - name: workspace
                  mountPath: /workspace
              env:
                # Provide either CLONE_URL or set GITHUB_REPOSITORY via env
                - name: CLONE_URL
                  value: ""
                - name: GITHUB_PAT
                  valueFrom:
                    secretKeyRef:
                      name: security-scan-secret
                      key: github_pat
                # Optional override of clone URL
              command: ["/scripts/run-scan.sh"]
          volumes:
            - name: trivy-cache
              persistentVolumeClaim:
                claimName: trivy-cache-pvc
            - name: workspace
              emptyDir: {}
          serviceAccountName: security-scanner-sa
          # backoffLimit is set on Job spec if needed
