apiVersion: batch/v1
kind: CronJob
metadata:
  name: security-scan-daily
  labels:
    app: security-scanner
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: security-scanner
        spec:
          restartPolicy: OnFailure
          containers:
            - name: scanner
              image: "{{ IMAGE_BASE | default('ghcr.io/' + lookup('env', 'GITHUB_REPOSITORY_OWNER') + '/eightbitsaxlounge-security') }}:{{ lookup('env','VERSION') }}"
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: trivy-cache
                  mountPath: /var/lib/trivy
                - name: workspace
                  mountPath: /workspace
              env:
                - name: CLONE_URL
                  value: "https://github.com/mchellmer/nineteenseventytwo-eightbitsaxlounge.git"
                - name: GITHUB_REPOSITORY
                  value: "mchellmer/nineteenseventytwo-eightbitsaxlounge"
                - name: GITHUB_PAT
                  valueFrom:
                    secretKeyRef:
                      name: security-scan-secret
                      key: github_pat
                - name: IMAGES
                  value: "ghcr.io/mchellmer/eightbitsaxlounge-data:latest,ghcr.io/mchellmer/eightbitsaxlounge-midi:latest,ghcr.io/mchellmer/eightbitsaxlounge-db:latest,ghcr.io/mchellmer/eightbitsaxlounge-ui:latest"
              command: ["/scripts/run-scan.sh"]
          volumes:
            - name: trivy-cache
              persistentVolumeClaim:
                claimName: trivy-cache-pvc
            - name: workspace
              emptyDir: {}
          serviceAccountName: security-scanner-sa
