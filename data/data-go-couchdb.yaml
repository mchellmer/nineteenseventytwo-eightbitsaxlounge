---
- name: Deploy Eightbitsaxlounge Data API on Kubernetes
  hosts: master
  tasks:
    - name: Create a temporary directory for manifests
      ansible.builtin.tempfile:
        state: directory
        suffix: data-k8s
      register: tempdir

    - name: Copy deployment manifest to temp directory
      ansible.builtin.copy:
        src: k8s/deployment.yaml
        dest: "{{ tempdir.path }}/deployment.yaml"

    - name: Copy service manifest to temp directory
      ansible.builtin.copy:
        src: k8s/service.yaml
        dest: "{{ tempdir.path }}/service.yaml"
    
    - name: Copy ingress manifest to temp directory
      ansible.builtin.copy:
        src: k8s/ingress.yaml
        dest: "{{ tempdir.path }}/ingress.yaml"

    - name: Deploy CouchDB Deployment
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/deployment.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Deploy CouchDB Service
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/service.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Deploy CouchDB Ingress
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/ingress.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Remove temporary directory
      ansible.builtin.file:
        path: "{{ tempdir.path }}"
        state: absent