- name: Deploy Eightbitsaxlounge Data API on Kubernetes
  hosts: master
  tasks:
    - name: Ensure required environment variables are provided
      ansible.builtin.assert:
        that:
          - lookup('env','NAMESPACE') | length > 0
          - lookup('env','VERSION') | length > 0
        fail_msg: "Missing required env vars: NAMESPACE and/or VERSION. Ensure the workflow passes them to Ansible."

    - name: Create a temporary directory for manifests
      ansible.builtin.tempfile:
        state: directory
        suffix: data-k8s
      register: tempdir

    - name: Template deployment manifest to temp directory
      ansible.builtin.template:
        src: k8s/deployment.yaml
        dest: "{{ tempdir.path }}/deployment.yaml"

    - name: Copy service manifest to temp directory
      ansible.builtin.copy:
        src: k8s/service.yaml
        dest: "{{ tempdir.path }}/service.yaml"
    
    - name: Determine Ingress Controller external IP (MetalLB)
      ansible.builtin.shell: |
        kubectl -n ingress-nginx get svc ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: ingress_ip_cmd
      changed_when: false

    - name: Compute data ingress host
      ansible.builtin.set_fact:
        data_ingress_host: >-
          {{ lookup('env','DATA_INGRESS_HOST')
             | default(( (lookup('env','NAMESPACE') == 'eightbitsaxlounge-prod')
                        | ternary('data.', 'data-dev.') ) ~ ingress_ip_cmd.stdout ~ '.sslip.io', true) }}

    - name: Template ingress manifest to temp directory
      ansible.builtin.template:
        src: k8s/ingress.yaml.j2
        dest: "{{ tempdir.path }}/ingress.yaml"
      vars:
        data_ingress_host: "{{ data_ingress_host }}"

    - name: Delete old ingress if it exists
      ansible.builtin.shell: |
        kubectl delete ingress eightbitsaxlounge-data-ingress -n $NAMESPACE --ignore-not-found=true
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Deploy CouchDB Deployment
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/deployment.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Deploy CouchDB Service
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/service.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Deploy CouchDB Ingress
      ansible.builtin.shell: |
        kubectl apply -n $NAMESPACE -f {{ tempdir.path }}/ingress.yaml
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Patch Deployment image to versioned tag
      ansible.builtin.shell: |
        IMAGE_BASE=${IMAGE_BASE:-ghcr.io/${GITHUB_REPOSITORY_OWNER}/eightbitsaxlounge-data}
        IMAGE="${IMAGE_BASE}:${VERSION}"
        kubectl -n "$NAMESPACE" set image deploy/eightbitsaxlounge-data \
          godata="${IMAGE_BASE}:${VERSION}"
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"
        VERSION: "{{ lookup('env', 'VERSION') }}"
        GITHUB_REPOSITORY_OWNER: "{{ lookup('env', 'GITHUB_REPOSITORY_OWNER') | default('', true) }}"
        IMAGE_BASE: "{{ lookup('env', 'IMAGE_BASE') | default('', true) }}"

    - name: Annotate Deployment with change cause
      ansible.builtin.shell: |
        kubectl -n "$NAMESPACE" annotate deploy/eightbitsaxlounge-data \
          kubernetes.io/change-cause="data ${VERSION}" --overwrite
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"
        VERSION: "{{ lookup('env', 'VERSION') }}"

    - name: Wait for rollout to complete
      ansible.builtin.shell: |
        kubectl -n "$NAMESPACE" rollout status deploy/eightbitsaxlounge-data --timeout=180s
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"
      when: lookup('env', 'NEEDS_BUILD') | default('true') == 'true'

    - name: Verify running image
      ansible.builtin.shell: |
        kubectl -n "$NAMESPACE" get deploy eightbitsaxlounge-data -o jsonpath='{.spec.template.spec.containers[0].image}'
      register: deploy_image
      environment:
        NAMESPACE: "{{ lookup('env', 'NAMESPACE') }}"

    - name: Print running image
      ansible.builtin.debug:
        msg: "Deployment image: {{ deploy_image.stdout }}"

    - name: Remove temporary directory
      ansible.builtin.file:
        path: "{{ tempdir.path }}"
        state: absent