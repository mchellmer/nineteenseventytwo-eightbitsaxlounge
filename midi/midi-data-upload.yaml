---
- name: Upload MIDI Data
  hosts: master
  vars:
    k8s_namespace: "{{ lookup('env', 'NAMESPACE') | default('eightbitsaxlounge-dev', true) }}"
    upload_type: "{{ lookup('env', 'UPLOAD_TYPE') | default('effects', true) }}"
    auth_client_id: "{{ lookup('env', 'AUTH_CLIENT_0_ID') }}"
    auth_client_secret: "{{ lookup('env', 'AUTH_CLIENT_0_SECRET') }}"
    service_url: "http://eightbitsaxlounge-midi-service.{{ k8s_namespace }}.svc.cluster.local:8080"

  tasks:
    - name: Request authentication token
      ansible.builtin.uri:
        url: "{{ service_url }}/api/token"
        method: POST
        body_format: json
        body:
          clientId: "{{ auth_client_id }}"
          clientSecret: "{{ auth_client_secret }}"
        status_code: [200, 201]
        return_content: yes
      register: token_response
      no_log: true

    - name: Parse token from response
      ansible.builtin.set_fact:
        auth_token: "{{ token_response.json.token }}"
      no_log: true

    - name: Determine endpoint based on upload type
      ansible.builtin.set_fact:
        endpoint: "{{ 'UploadEffects' if upload_type == 'effects' else 'UploadDevices' }}"

    - name: Upload {{ upload_type }} data
      ansible.builtin.uri:
        url: "{{ service_url }}/api/Midi/{{ endpoint }}"
        method: POST
        headers:
          Authorization: "Bearer {{ auth_token }}"
        status_code: [200, 201, 204]
        return_content: yes
      register: upload_result

    - name: Display upload result
      ansible.builtin.debug:
        msg: "{{ upload_type | capitalize }} upload completed successfully (HTTP {{ upload_result.status }})"

    - name: Display response body on success
      ansible.builtin.debug:
        msg: "{{ upload_result.content }}"
      when: upload_result.content | length > 0
